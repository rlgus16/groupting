rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // 기본 규칙: 인증되지 않은 접근 차단
    match /{document=**} {
      allow read, write: if false;
    }

    // 사용자 컬렉션
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      // 다른 유저 정보 읽기 허용 (프로필 조회 등)
      allow read: if request.auth != null;

      // [여기 추가됨 1] 차단 목록 서브 컬렉션 (내 차단 목록은 나만 관리)
      match /blocked_users/{blockedUserId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // 그룹 컬렉션
    match /groups/{groupId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.ownerId;
      allow read: if request.auth != null;
      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId;
      allow update: if request.auth != null && (
        request.auth.uid in resource.data.memberIds ||
        (
          !(request.auth.uid in resource.data.memberIds) &&
          request.resource.data.memberIds == resource.data.memberIds.concat([request.auth.uid]) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberIds', 'updatedAt'])
        )
      );
    }

    // 채팅방 컬렉션
    match /chatrooms/{chatroomId} {
      allow read, write, update: if request.auth != null && (
        (resource != null && request.auth.uid in resource.data.participants) ||
        (exists(/databases/$(database)/documents/groups/$(chatroomId)) &&
         request.auth.uid in get(/databases/$(database)/documents/groups/$(chatroomId)).data.memberIds)
      );
      allow create: if request.auth != null && (
         exists(/databases/$(database)/documents/groups/$(chatroomId)) &&
         request.auth.uid in get(/databases/$(database)/documents/groups/$(chatroomId)).data.memberIds
      );
    }

    // 메시지 컬렉션
    match /messages/{messageId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.senderId;
      allow read: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.senderId;
    }

    // 초대장 컬렉션
    match /invitations/{invitationId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.fromUserId;
      allow read: if request.auth != null && (request.auth.uid == resource.data.fromUserId || request.auth.uid == resource.data.toUserId);
      allow update: if request.auth != null && request.auth.uid == resource.data.toUserId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.fromUserId;
    }

    // 닉네임 선점 규칙 (좀비 데이터 정리 허용)
    match /nicknames/{nickname} {
      allow read: if request.auth != null;
      // 생성은 누구나 가능 (단, 앱 로직에서 중복 체크)
      allow create: if request.auth != null;
      // 삭제/수정 조건: 내 것이거나 OR 연결된 유저(uid)가 DB에 없으면(좀비) 삭제 가능
      allow update, delete: if request.auth != null && (
        request.auth.uid == resource.data.uid ||
        !exists(/databases/$(database)/documents/users/$(resource.data.uid))
      );
    }

    // 전화번호 선점 규칙 (좀비 데이터 정리 허용)
    match /phoneNumbers/{phoneNumber} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      // 삭제/수정 조건: 내 것이거나 OR 연결된 유저(uid)가 DB에 없으면(좀비) 삭제 가능
      allow update, delete: if request.auth != null && (
        request.auth.uid == resource.data.uid ||
        !exists(/databases/$(database)/documents/users/$(resource.data.uid))
      );
    }

    // 차단 관리 컬렉션 (쌍방 차단용)
        // ID 형식: "차단한UID_차단당한UID"
        match /blocks/{blockId} {
          // 생성: 본인이 차단하는 경우만 허용
          allow create: if request.auth != null && request.auth.uid == request.resource.data.blockerId;
          // 읽기: 차단한 사람(blocker)과 차단당한 사람(blocked) 모두 읽기 가능
          allow read: if request.auth != null && (
            request.auth.uid == resource.data.blockerId ||
            request.auth.uid == resource.data.blockedId
          );
          // 삭제(차단 해제): 차단한 사람만 가능
          allow delete: if request.auth != null && request.auth.uid == resource.data.blockerId;
        }

    // [여기 추가됨 2] 신고 컬렉션 (누구나 생성 가능)
    match /reports/{reportId} {
      allow create: if request.auth != null;
    }
  }
}